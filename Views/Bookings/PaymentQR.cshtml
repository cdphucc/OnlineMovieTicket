@model OnlineMovieTicket.Models.VietQRResponseModel
@{
    ViewBag.Title = "Thanh toán QR Code";
    var booking = ViewBag.Booking as OnlineMovieTicket.Models.Booking;
    var qrResult = ViewBag.QRResult as OnlineMovieTicket.Models.VietQRResponseModel;
}

@if (booking == null || qrResult == null)
{
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-danger text-center">
                    <h4><i class="fas fa-exclamation-triangle me-2"></i>Lỗi</h4>
                    <p>Không thể tải thông tin thanh toán. Vui lòng thử lại.</p>
                    <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Về trang chủ</a>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-info text-white text-center">
                        <h4 class="mb-0"><i class="fas fa-qrcode me-2"></i>Thanh toán QR Code</h4>
                    </div>
                    <div class="card-body text-center">

                        <!-- Thông tin đơn hàng -->
                        <div class="alert alert-info">
                            <h5>Thông tin đơn hàng #@booking.Id</h5>
                            <p><strong>Số tiền:</strong> <span class="text-danger fs-4">@booking.TotalAmount.ToString("n0") VNĐ</span></p>
                            <p><strong>Nội dung:</strong> @(qrResult.Description ?? "Thanh toán vé xem phim")</p>
                        </div>

                        <!-- QR Code -->
                        <div class="mb-4">
                            <div class="card border-primary" style="max-width: 350px; margin: 0 auto;">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">Quét mã QR để thanh toán</h6>
                                    @if (!string.IsNullOrEmpty(qrResult.QRCode))
                                    {
                                        <img src="@qrResult.QRCode" alt="QR Code" class="img-fluid mb-3" style="max-width: 250px;">
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Không thể tạo mã QR
                                            @if (!string.IsNullOrEmpty(qrResult.ErrorMessage))
                                            {
                                                <br>

                                                <small>@qrResult.ErrorMessage</small>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Hướng dẫn -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">
                                            <i class="fas fa-mobile-alt me-2"></i>Cách thanh toán
                                        </h6>
                                        <ol class="text-start">
                                            <li>Mở ứng dụng ngân hàng trên điện thoại</li>
                                            <li>Tìm chức năng "Quét QR" hoặc "QR Code"</li>
                                            <li>Quét mã QR phía trên</li>
                                            <li>Xác nhận thông tin và thanh toán</li>
                                            <li>Quay lại và nhấn "Đã thanh toán"</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">
                                            <i class="fas fa-university me-2"></i>Thông tin tài khoản
                                        </h6>
                                        <div class="text-start">
                                            <p><strong>Ngân hàng:</strong> BIDV</p>
                                            <p><strong>Chủ TK:</strong> CHU DUC PHUC</p>
                                            <p><strong>Nội dung:</strong> <span class="text-muted">Tự động điền</span></p>
                                            <p><strong>Số tiền:</strong> <span class="text-danger">@booking.TotalAmount.ToString("n0") VNĐ</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Countdown Timer -->
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-clock me-2"></i>
                            <strong>Thời gian còn lại:</strong>
                            <span id="countdown" class="fs-5 text-danger">15:00</span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <form asp-action="ConfirmQRPayment" method="post" id="confirmForm">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="bookingId" value="@booking.Id" />
                                <button type="submit" class="btn btn-success btn-lg mb-2" id="confirmBtn">
                                    <i class="fas fa-check-circle me-2"></i>Đã thanh toán xong
                                </button>
                            </form>

                            <!-- Nút hủy giao dịch -->
                            <form asp-action="CancelTransaction" method="post" id="cancelForm" class="mb-2">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="bookingId" value="@booking.Id" />
                                <button type="submit" class="btn btn-danger btn-lg" id="cancelBtn">
                                    <i class="fas fa-times-circle me-2"></i>Hủy giao dịch
                                </button>
                            </form>

                            <a href="@Url.Action("PaymentQR", new { bookingId = booking.Id })" class="btn btn-outline-secondary">
                                <i class="fas fa-refresh me-1"></i>Làm mới trang
                            </a>

                            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-info">
                                <i class="fas fa-home me-1"></i>Về trang chủ
                            </a>
                        </div>

                        <!-- Auto-refresh notification -->
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-sync-alt me-1"></i>
                                Trang sẽ tự động kiểm tra thanh toán sau mỗi 30 giây
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .countdown-expired {
        color: #dc3545 !important;
        animation: blink 1s infinite;
    }
</style>

<script>
    // Countdown Timer (15 minutes)
    let timeLeft = 7 * 60; // 7 minutes in seconds

    function updateCountdown() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        const countdownElement = document.getElementById('countdown');
        if (countdownElement) {
            countdownElement.textContent = display;

            // SỬA LỖI: Dùng cách khác thay vì <=
            if (timeLeft < 301) { // 5 minutes left (300 seconds + 1)
                countdownElement.classList.add('countdown-expired');
            }

            if (timeLeft < 1) { // Thay vì <= 0
                clearInterval(countdownInterval);
                countdownElement.textContent = 'Hết thời gian';
                const confirmBtn = document.getElementById('confirmBtn');
                const cancelBtn = document.getElementById('cancelBtn');

                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>Hết thời gian thanh toán';
                    confirmBtn.className = 'btn btn-danger btn-lg mb-2';
                }

                if (cancelBtn) {
                    cancelBtn.disabled = true;
                    cancelBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>Hết thời gian';
                    cancelBtn.className = 'btn btn-secondary btn-lg';
                }

                // Auto cancel after timeout
                setTimeout(() => {
                    if (confirm('Hết thời gian thanh toán. Bạn có muốn hủy giao dịch không?')) {
                        document.getElementById('cancelForm').submit();
                    } else {
                        window.location.href = '@Url.Action("Index", "Home")';
                    }
                }, 3000);
                return;
            }
        }

        timeLeft--;
    }

    const countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown(); // Initial call

    // Confirm form submission
    const confirmForm = document.getElementById('confirmForm');
    if (confirmForm) {
        confirmForm.addEventListener('submit', function(e) {
            const confirmed = confirm('Bạn có chắc chắn đã thanh toán xong?');
            if (!confirmed) {
                e.preventDefault();
                return false;
            }

            const btn = document.getElementById('confirmBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xác nhận...';
            }
        });
    }

    // Cancel form submission
    const cancelForm = document.getElementById('cancelForm');
    if (cancelForm) {
        cancelForm.addEventListener('submit', function(e) {
            const confirmed = confirm('Bạn có chắc chắn muốn hủy giao dịch này? Ghế đã chọn sẽ được giải phóng.');
            if (!confirmed) {
                e.preventDefault();
                return false;
            }

            const btn = document.getElementById('cancelBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang hủy...';
            }
        });
    }
</script>