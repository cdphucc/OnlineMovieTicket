@model OnlineMovieTicket.Models.ViewModels.EditUserViewModel
@{
    ViewData["Title"] = "Edit User";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-user-edit"></i> Edit User
                    </h4>
                </div>
                <div class="card-body">
                    <form asp-action="EditUser" method="post">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="CreatedAt" />
                        <input type="hidden" asp-for="UpdatedAt" />
                        
                        <!-- Personal Information Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Personal Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="FullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                                            <input asp-for="FullName" class="form-control" />
                                            <span asp-validation-for="FullName" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                                            <input asp-for="Email" class="form-control" />
                                            <span asp-validation-for="Email" class="text-danger"></span>
                                            <small class="form-text text-muted">Changing email will also update the username.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Role & Security Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Role & Security</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label asp-for="Role" class="form-label">User Role <span class="text-danger">*</span></label>
                                    <select asp-for="Role" class="form-select">
                                        @foreach (var role in ViewBag.Roles as List<OnlineMovieTicket.Models.UserRole>)
                                        {
                                            <option value="@role">@role</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Role" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        <strong>Warning:</strong> Changing user roles affects their permissions and access levels.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- System Information Section (Read-only) -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">System Information (Read-only)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Created At</label>
                                            <input value="@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")" class="form-control" readonly />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Last Updated At</label>
                                            <input value="@(Model.UpdatedAt?.ToString("yyyy-MM-dd HH:mm:ss") ?? "Never")" class="form-control" readonly />
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label class="form-label">User ID</label>
                                    <input value="@Model.Id" class="form-control" readonly />
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <a href="@Url.Action("UserManagement")" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Back to User Management
                                    </a>
                                    <button type="button" class="btn btn-warning" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> Reset Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            // Store original values for reset functionality
            var originalValues = {};
            $('input, select, textarea').each(function() {
                var element = $(this);
                if (!element.prop('readonly') && !element.is(':hidden')) {
                    originalValues[element.attr('name')] = element.val();
                }
            });

            // Confirm form submission
            $('form').on('submit', function(e) {
                if (!confirm('Are you sure you want to save these changes?')) {
                    e.preventDefault();
                    return false;
                }
            });

            // Reset form function
            window.resetForm = function() {
                if (confirm('Are you sure you want to reset all changes?')) {
                    for (var name in originalValues) {
                        $('[name="' + name + '"]').val(originalValues[name]);
                    }
                }
            };

            // Highlight changed fields
            $('input, select, textarea').not(':hidden, [readonly]').on('change', function() {
                var element = $(this);
                var name = element.attr('name');
                if (originalValues[name] && originalValues[name] !== element.val()) {
                    element.addClass('border-warning');
                } else {
                    element.removeClass('border-warning');
                }
            });

            // Email validation
            $('#Email').on('blur', function() {
                var email = $(this).val();
                if (email && !isValidEmail(email)) {
                    $(this).addClass('border-danger');
                } else {
                    $(this).removeClass('border-danger');
                }
            });

            function isValidEmail(email) {
                var emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                return emailRegex.test(email);
            }
        });
    </script>
}